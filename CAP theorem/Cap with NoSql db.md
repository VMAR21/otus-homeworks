## CAP with MongoDB

CAP - это аббревиатура для 3 составляющих:
1. C - согласованность
2. A - доступность
3. P - устойчивость к разделению.

Устойчивость к разделению (P) достигается за счет реплик и переключения между ними.

Согласованность и доступность в MongoDB можно настроить с помощью параметров: 
 - Read Concern
 - Write Concern

#### CP в MongoDB

Если мы хотим добиться CP, то ставим приоритет на чтение и запись в "большниство":

```javascript
const transactionOptions = {
    readConcern: { level: 'majority' },
    writeConcern: { w: 'majority' }
}
```

Согласно официальной документации, параметр "majority" (большинство) гарантирует, что считанные данные были подтверждены большинством членов набора реплик. Считанные документы являются долговечными и гарантированно не откатываются. 

Для операции в многодокументных транзакциях надо устанавливать и readConcern и writeConcern в "majority". 

#### AP в MongoDB

Если мы хотим добиться AP, то ставим следующие параметры:
```javascript
const transactionOptions = {
    readConcern: { level: 'local' },
    writeConcern: { w: '1' }
}
```

**writeConcern со значением "1"**  запрашивает подтверждение того, что операция записи была распространена на standalone mongod или основной в наборе реплик. Данные можно откатить, если основной сервер отключается до того, как операции записи были реплицированы на любой из вторичных.

**readConcern со значением "local"** возвращает данные из экземпляра без гарантии того, что данные были записаны в большинство членов набора реплик (т. е. возможен откат).

Соответственно, суммарно эти параметры дают нам необходимую доступность к базе, но не гарантируют согласованность между репликами бд.

**В итоге**: для достижения CP или AP необходимо менять настройки writeConcern и readConcern


## CAP with MSSQL

Изначально, MSSQL - нераспределенная реляционная СУБД, соответственно она обеспечивает CA (согласованность и доступность) за счет транзакционности и одного сервера.

Однако, в MSSQL существует три вида репликации:

1. **Транзакционная**. Изменения в базе на мастер-сервере транслируются на slave-сервер с минимальной задержкой, зависящей от скорости сети и аппаратных мощностей. При появлении транзакций в объектах, участвующих в репликации, на издателе, агент чтения журналов копирует эти транзакции на экземпляр-распространитель, затем агент распространитель копирует данные на подписчиков.
2. **Слияния**. Отличается от стандартной транзакционной своей многонаправленностью. Репликация слиянием использует агента слияния для репликации изменений данных на издателе и подписчике.
3. **Снимками**. На подписчике применяется снапшот данных из публикации без задействования журналов транзакций и триггеров.

Использование **транзакционной репликации** обечпечивает хорошую согласованность (C) за счет синхронизации и минимальной задержки между мастером и слейвами.

Использование **репликации слиянием** обеспечивает 
хорошую доступность (A) потому, что подписчики могут работать независимо от мастера, при этом данные между подписчиками могут устаревать - пока не произойдет синхронизация и слияние (не соответствует хорошей согласованности)

Использование **репликации снимакми** обеспечивает хорошую доступность (А) аналогично с репликацией слиянием

**В итоге**:
- Изначально MSSQL - CA
- С репликацией транзакциями - CP
- С репликацией слиянием и снимаками - AP

## CAP with Cassandra

Согласно следующему источнику (https://ru.wikipedia.org/wiki/Apache_Cassandra) Cassandra - это распределённая система управления базами данных, которая относится к категории отказоустойчивых СУБД: помещённые в базу данные автоматически реплицируются на несколько узлов распределённой сети или даже равномерно распределяются в нескольких дата-центрах.

Соответственно, Cassandra обеспечивает хорошую доступность (A) и отказоусточивость (P) - AP.

Также, в Cassandra можно выбирать различные **настройки согласованности (consistency)** данных на запись и на чтение.
Данные настройки влияют на то, сколько подтверждений должен получить координатор, чтобы сообщить пользователю, что его запрос завершен успешно. 

Есть различные варианты задания **consistency level**: 
- any
- 1, 2, 3
- quorum
- all
- и другие

ALL: дожидаемся ответа со всех реплик-нод всех кластеров.

Для достижения полной согласованности (eventual consistency) необходимо, чтобы суммарное количество подтверждений от реплик на запись и чтение должно быть строго больше чем ваш replication factor: W + R > RF 
В таком случае мы сможем обеспечить CP.

**В итоге**:
- Изначально Cassandra обеспечивает AP
- С настройками consistency level - CP

